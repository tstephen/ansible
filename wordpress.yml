---
- hosts: wordpress-sites
  become: yes
  vars:
    reqd_packages:
      - apache2
      - git
      - libapache2-mod-php5
      - php5
      - php5-curl
      - php5-mcrypt
      - php5-mysql
      - python-pip
      - unzip
    wp_dirs:
      - /wp-content
      - /wp-content/uploads
      - /wp-content/upgrades
    wp_plugins:
      - gitium.zip
      - jetpack.4.8.2.zip
      - types.2.2.9.zip
      - wordpress-importer.0.6.3.zip
#  roles:
#    - { role: geerlingguy.mysql }


  tasks:
    - name: Ensure pre-reqs for ansible management
      become: yes
      apt: state=installed pkg={{ item }}
      with_items: "{{ reqd_packages }}"

    - name: Install the Python MySQL module
      pip:
        name: MySQL-python

    - name: Install CertBot for certificate install and renewal
      become: yes
      get_url:
        url: https://dl.eff.org/certbot-auto
        dest: /usr/bin
        mode: a+x

    #- name: Run CertBot on apache (needs to be manual for now)
    #  shell: certbot-auto --apache

    # Create job like 34 4 * * * certbot-auto renew --quiet --no-self-upgrade
    - name: crontab to autorenew certs
      cron:
        name: "Renew letsencrypt certificates regularly"
        minute: "34"
        hour: "4"
        job: "certbot-auto renew --quiet --no-self-upgrade"

    - name: Ensure WP database exists
      become: yes
      mysql_db:
        login_user: '{{ mysql_root_username }}'
        login_password: '{{ mysql_root_password }}'
        name: '{{ wp_db_name }}'
        state: present

    - name: Ensure WP db user exists
      mysql_user:
        login_user: '{{ mysql_root_username }}'
        login_password: '{{ mysql_root_password }}'
        name: '{{ wp_db_user }}'
        password: '{{ wp_db_pass }}'
        priv: '{{ wp_db_name }}.*:ALL'
        state: present

    - name: Create WP docs dir
      become: yes
      file:
        path: '{{ wp_dir }}'
        state: directory
        owner: www-data
        group: www-data
        mode: 0775

    - name: Provision WP site
      become: yes
      template:
        src: src/templates/site-conf.j2
        dest: '/etc/apache2/sites-available/{{ tenant_id }}.conf'
        owner: root
        group: root
        mode: 0644
      register: apache_config

    - name: Enable WP site
      become: yes
      file:
        src: '/etc/apache2/sites-available/{{ tenant_id }}.conf'
        dest: '/etc/apache2/sites-enabled/{{ tenant_id }}.conf'
        state: link

    - name: Reload Apache config
      become: yes
      service:
        name: apache2
        state: reloaded
      when: apache_config.changed

    - name: Check WP install
      stat:
        path: '{{ wp_dir }}/wp-includes'
      register: wp

    - name: Unarchive WP files
      become: yes
      become_user: www-data
      unarchive:
        src: https://wordpress.org/latest.zip
        dest: '{{ wp_dir }}'
        remote_src: True
        owner: www-data
        group: www-data
        #mode: 0664
      when: wp.stat.isdir is undefined

    - name: Create WP DB script
      template:
        src: src/templates/wordpress-sql.j2
        dest: '/var/tmp/wordpress-{{ tenant_id }}.sql'
        mode: 0644

    - name: Create remote WP DB backup script
      template:
        src: src/templates/wp-db-remote-backup.sh.j2
        dest: '/home/{{ ansible_ssh_user }}/{{ tenant_id }}-wp-db-remote-backup.sh'
        owner: "{{ ansible_ssh_user }}"
        group: www-data
        mode: 0744

    # Creates an job like "0 5 * * * /home/tstephen/foo-wp-db-remote-backup.sh"
    - name: Ensure cron job for db backup exists
      cron:
        name: "remote backup {{ tenant_id }}_wp_db"
        minute: "0"
        hour: "5"
        job: '/home/{{ ansible_ssh_user }}/{{ tenant_id }}-wp-db-remote-backup.sh'
        user: "{{ ansible_ssh_user }}"

    - name: Create WP DB backup script
      template:
        src: src/templates/wp-db-backup.sh.j2
        dest: '/home/{{ ansible_ssh_user }}/{{ tenant_id }}-wp-db-backup.sh'
        owner: "{{ ansible_ssh_user }}"
        group: www-data
        mode: 0744

    # Creates an job like "0 19 * * * /home/tstephen/foo-wp-db-backup.sh"
    - name: Ensure cron job for db backup exists
      cron:
        name: "backup {{ tenant_id }}_wp_db"
        minute: "0"
        hour: "19"
        job: '/home/{{ ansible_ssh_user }}/{{ tenant_id }}-wp-db-backup.sh'
        user: "{{ ansible_ssh_user }}"

    - name: Create WP move script
      become: yes
      template:
        src: src/templates/wp-post-install-sh.j2
        dest: '/var/tmp/wp-post-install-{{ tenant_id }}.sh'
        owner: www-data
        group: www-data
        mode: 0744
      when: wp.stat.isdir is undefined

    - name: WP post install (db & files)
      become: yes
      become_user: www-data
# Cannot seem to get the shell or command modules to do this.
#      shell: mv '{{ wp_dir }}/wordpress/' '{{ wp_dir }}/'
      shell: /var/tmp/wp-post-install-{{ tenant_id }}.sh
      when: wp.stat.isdir is undefined

    - name: Create WP dirs if not existing and set permissions
      file:
        path: '{{ wp_dir }}{{ item }}'
        state: directory
        owner: www-data
        group: www-data
        mode: 0775
      with_items: "{{ wp_dirs }}"

    # Cannot use file as will not fail if file absent (see docs)
    # however touch results in a change every time
    - name: Ensure htaccess available and with right permissions
      file:
        path: '{{ wp_dir }}/.htaccess'
        state: touch
        owner: www-data
        group: www-data
        mode: 0664

    - name: Check WP config
      stat:
        path: '{{ wp_dir }}/wp-config.php'
      register: wpconfig

#    - name: Gen WP salts
#      get_url: https://api.wordpress.org/secret-key/1.1/salt/

    - name: Install WP config
      become: yes
      template:
        src: src/templates/wp-config.j2
        dest: '{{ wp_dir }}/wp-config.php'
        owner: www-data
        group: www-data
        mode: 0660
      when: wpconfig.stat.exists is undefined or wpconfig.stat.exists == False

    - name: Install WP plugins
      become: yes
      become_user: www-data
      unarchive:
        src: 'https://downloads.wordpress.org/plugin/{{ item }}'
        dest: '{{ wp_dir }}/wp-content/plugins/'
        remote_src: True
        owner: www-data
        group: www-data
      with_items: "{{ wp_plugins }}"
      when: wp.stat.isdir is undefined

    - name: Install Omny Link forms plugin
      become: yes
      become_user: www-data
      unarchive:
        src: src/rest-forms.zip
        dest: '{{ wp_dir }}/wp-content/plugins/'
        owner: www-data
        group: www-data
      when: wp.stat.isdir is undefined

    - name: Install Bootstrap starter theme
      become: yes
      become_user: www-data
      unarchive:
        src: src/bst.zip
        dest: '{{ wp_dir }}/wp-content/themes/'
        owner: www-data
        group: www-data
      when: wp.stat.isdir is undefined

    - name: Rename theme to tenant name
      command: creates="{{ wp_dir }}/wp-content/themes/{{ tenant_id }}" mv {{ wp_dir }}/wp-content/themes/bst {{ wp_dir }}/wp-content/themes/{{ tenant_id }}
      when: wp.stat.isdir is undefined

    - name: Check Omny config
      stat:
        path: '{{ wp_dir }}/wp-content/themes/{{ tenant_id }}/tenant-config.json'
      register: omnyconfig

    - name: Create basic Omny config
      become: yes
      template:
        src: src/templates/tenant-config.json.j2
        dest: '{{ wp_dir }}/wp-content/themes/{{ tenant_id }}/tenant-config.json'
        force: no
        owner: www-data
        group: www-data
        mode: 0664
      when: omnyconfig.stat.exists is undefined or omnyconfig.stat.exists == False

    - name: Remove default WP plugin 'dolly'
      become: yes
      file: path='{{ wp_dir }}/wp-content/plugins/hello.php' state=absent

    - name: Remove default WP plugin 'akismet'
      become: yes
      file: path='{{ wp_dir }}/wp-content/plugins/akismet' state=absent

    - name: Remove default WP theme 'twentyfifteen'
      become: yes
      file: path='{{ wp_dir }}/wp-content/themes/twentyfifteen' state=absent

    - name: Remove default WP theme 'twentysixteen'
      become: yes
      file: path='{{ wp_dir }}/wp-content/themes/twentysixteen' state=absent

    - name: Init git repo
      become_user: www-data
      command: git init
      args:
        chdir: "{{ wp_dir }}"
      when: wp.stat.isdir is undefined

    - name: Check if origin is set
      command: git remote
      args:
        chdir: "{{ wp_dir }}"
      register: origin

    - name: Setup origin for git
      command: git remote add origin http://gitium:{{ gitium_pass }}@code.knowprocess.com/omny/{{ tenant_id }}
      args:
        chdir: "{{ wp_dir }}"
      when: origin.stdout != 'origin'

    - name: Add WP files to git
      command: git add {{ wp_dir }}
      args:
        chdir: "{{ wp_dir }}"
      when: origin.stdout != 'origin'

    - name: Change ownership of git dir
      file:
        path: "{{ wp_dir }}/.git"
        owner: www-data
        group: www-data
        recurse: yes
        mode: "u+rw,g+rw,o-w"

    # This often fails claiming that git --global config user.xxx is unset
    #- name: Initial commit
    #  become_user: www-data
    #  command: git commit -m "Initial commit"
    #  args:
    #    chdir: "{{ wp_dir }}"
    #  when: wp.stat.isdir is undefined and origin.stdout != 'origin'

